using System;
using System.Collections.Generic;
using TMPro;
using Unity.Netcode;
using UnityEngine;
using UnityEngine.UI;

public class StackBattleManager : NetworkBehaviour
{
	// 게임에 참여하는 유저 관련
	[SerializeField] private int maxPlayers;
	private List<ulong> playerIds = new List<ulong>(); // 참가한 플레이어 ID 리스트

	// 현재 차례 플레이어 ID
	private NetworkVariable<ulong> currentTurnPlayerId = new NetworkVariable<ulong>(0);

	public TMP_Text turnText;
	public Button turnButton;
	public BlockSpawnHandler spawner;

	private void Start()
	{
		turnButton.onClick.AddListener(() =>
		{
			if (NetworkManager.Singleton.IsClient)
			{
				RequestNextTurnServerRpc(NetworkManager.Singleton.LocalClientId);
			}
		});

		currentTurnPlayerId.OnValueChanged += UpdateButtonInteractable;
		currentTurnPlayerId.OnValueChanged += UpdateTurnUI;
		UpdateTurnUI(0, GetCurrentTurnPlayerId());
	}

	public override void OnNetworkSpawn()
	{
		if (IsServer)
		{
			NetworkManager.Singleton.OnClientConnectedCallback += OnPlayerJoined;
		}
	}

	private void OnPlayerJoined(ulong clientId)
	{
		if (!playerIds.Contains(clientId))
		{
			playerIds.Add(clientId);
		}

		// 첫 번째 플레이어가 게임 시작 시 첫 턴을 가짐
		if (playerIds.Count == 1)
		{
			currentTurnPlayerId.Value = playerIds[0];
		}
	}

	[ServerRpc(RequireOwnership = false)]
	public void RequestNextTurnServerRpc(ulong senderClientId)
	{
		if (currentTurnPlayerId.Value == senderClientId)
		{
			spawner.DropBlock();
			int currentIndex = playerIds.IndexOf(senderClientId);
			int nextIndex = (currentIndex + 1) % playerIds.Count;
			currentTurnPlayerId.Value = playerIds[nextIndex]; // 턴 넘김
			spawner.CreateBlock();
		}
	}

	public ulong GetCurrentTurnPlayerId()
	{
		return currentTurnPlayerId.Value;
	}

	private void UpdateButtonInteractable(ulong previousValue, ulong newValue)
	{
		turnButton.interactable = (newValue == NetworkManager.Singleton.LocalClientId);
	}

	private void UpdateTurnUI(ulong previousValue, ulong newValue)
	{
		turnText.text = $"Current Turn : Player {newValue}";
	}
}
